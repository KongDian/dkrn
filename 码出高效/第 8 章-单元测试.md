# 第 8 章 单元测试

软件产品通常是由模块组合而成，模块又可以分成诸多子模块。最终的子模块是由不可再分的程序单元组成。对于这些程序单元的测试，即称为单元测试（Unit Testing，简称单元测试）。在面向对象编程中，通常认为最小单元就是方法。

单元测试的好处包括但不限于以下几点：

1. 提升软件质量
2. 促进代码优化
3. 增加重构自信
4. 提升研发效率

## 8.1 单元测试的基本原则

宏观上，单元测试要符合 AIR 原则；微观上，单元测试的代码层面要符合 BCDE 原则。

AIR 原则具体包括：

- A：Automatic（自动化）
- I：Independent（独立性）
- R：Repeatable（可重复）

单元测试应该是自动执行的。

为了保证单元测试稳定可靠便于维护，需要保证其独立性。用例之间不允许相互调用，也不允许出现执行次序的先后依赖。JUnit 的用例执行顺序是无序的，而 TestNG 支持测试用例的顺序执行（默认测试类内部各测试用例是按字典升序执行的，也可以通过 XML或 注解 priority 的方式来配置执行顺序）。

单元测试是可以重复执行的，不能受到外界环境的影响。

编写单元测试时要保证测试粒度要足够小。

编写单元测试用例时需要符合 BCDE 原则。

- B：Border，边界值测试，包括循环边界、特殊取值、特殊时间点、数据顺序等。
- C：Correct，正确的输入，并得到预期结果。
- D：Design，与设计文档结合，来编写单元测试。
- E：Error，单元测试的目标时证明程序有错，而不是程序无措。

由于单元测试只是系统集成测试前的小模块测试，有些因素往往不具备，因此需要进行 Mock，例如：

（1）功能因素。比如单元测试方法内部调用功能不可用。

（2）时间因素。与时间相关的功能点。

（3）环境因素。政策环境，多端环境。

（4）数据因素。数据样本过小。

（5）其他因素。

最简单的 Mock 方式是硬编码，更优雅的方式是使用配置文件，最佳的方式是使用 Mock 框架，如 JMock、EasyMock、JMock等。



## 8.2 单元测试覆盖率

单元测试时以一种白盒测试，测试者依据程序的内部结构来实现测试代码。单元测试覆盖率是指业务代码被单元测试的比例和程度。

1. 粗粒度的覆盖。

   粗粒度的覆盖包括类覆盖和方法覆盖两种。类覆盖是指类中只要有方法或变量被测试用例调用或执行到，那么就说这个类被测试覆盖了。

   方法覆盖，只要在测试用例的执行过程中，某个方法被调用了，都认为该类被覆盖了。

2. 细粒度的覆盖。

   (1) 行覆盖。也称语句覆盖，用来量度可执行的语句是否被执行到。

   (2) 分支覆盖。也称判定覆盖，用来量度程序中每个判断分支是否都被执行到。

   (3) 条件判定覆盖。要求能够让每个条件的所有可能情况至少被执行一次，同时每个判定本身的所有可能结果也至少执行一次。

   (4) 条件组合覆盖。是指判定中所有条件的各种组合情况都至少出现一次。

   (5) 路径覆盖。要求能够测试到程序中所有可能路径。

## 8.3 单元测试编写

Java 单元测试框架，JUnit 和 TestNG。

JUnit5.x 由以下三个只要模块组成。

- JUnit Platform：用于在 JVM 上启动测试框架，统一命令行、Gradle 和 Maven 等方式执行测试入口。
- JUnit Jupiter：包含 JUnit5.x 全新编程模型和扩展机制。
- JUnit Vintage：用于在新的框架中兼容运行 Unit3.x 和 Unit4.x 的测试用例。

JUnit 常用测试注解：

| 注解               | 释义                                                         |
| ------------------ | ------------------------------------------------------------ |
| @Test              | 注明一个方法是测试方法。JUnit 框架会在测试阶段自动找到所有使用该注解表明的测试方法并运行。JUnit5 中取消了该注释的 timeout 参数的支持。 |
| @TestFactory       | 注明一个方法是基于数据驱动的动态测试数据源。                 |
| @ParameterizedTest | 注明一个方法是测试方法，同 @Test。同时可以让一个测试方法使用不同的入参进行多次。 |
| @RepeatedTest      | 让测试方法自定义重复运行次数。                               |
| @BeforeEach        | 与 JUnit4 中的 @Before 类似，可以在每个测试方法运行前，都运行一个指定的方法。在 JUnit5 中，初了运行 @Test 注解的方法，还额外支持运行 @ParameterizedTest 和 @RepeatedTest |
| @AfterEach         | 与 JUnit4 中的 @After类似，可以在每个测试方法运行后，都运行一个指定的方法。在 JUnit5 中，初了运行 @Test 注解的方法，还额外支持运行 @ParameterizedTest 和 @RepeatedTest |
| @BeforeAll         |                                                              |
|                    |                                                              |
|                    |                                                              |
|                    |                                                              |
|                    |                                                              |

